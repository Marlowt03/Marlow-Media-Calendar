<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Firestore Smoke Test (Compat 9.19.1)</title>
  <!-- Only two compat scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 24px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
    button { padding:10px 14px; border-radius:8px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer }
    #log { white-space: pre-wrap; border:1px solid #eee; padding:12px; border-radius:8px; background:#fafafa; min-height:160px; }
    input[type=text] { width: 420px; padding: 8px; border-radius: 6px; border:1px solid #ddd; }
    .ok { color:#0a7; }
    .warn { color:#c70; }
    .err { color:#c33; }
  </style>
</head>
<body>
  <h1>Firestore Smoke Test</h1>
  <p>This is a minimal page that proves Firebase compat init + Firestore read/write works in any browser (including Incognito).</p>

  <div class="row">
    <button onclick="initNow()">1) Init Firebase</button>
    <button onclick="readOrg()">2) Read org doc</button>
    <button onclick="writeOrg()">3) Write test task</button>
    <button onclick="readOrg()">4) Read again</button>
  </div>

  <div class="row">
    <label>Doc Path:&nbsp;<input id="path" type="text" value="dashboards/org-marlow-media"></label>
  </div>

  <div id="log">Ready.</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD-lQOz47WSM0BOT0oT29vDNbNjaWqH6r8",
    authDomain: "marlow-media-calendar.firebaseapp.com",
    projectId: "marlow-media-calendar",
    storageBucket: "marlow-media-calendar.appspot.com",
    messagingSenderId: "664519075124",
    appId: "1:664519075124:web:6380ee0e1ddb07b3c6f161"
  };
  window.firebaseConfig = firebaseConfig;

  function log(msg, cls) {
    const box = document.getElementById('log');
    const p = document.createElement('div');
    if (cls) p.className = cls;
    p.textContent = msg;
    box.appendChild(p);
  }

  function path() { return document.getElementById('path').value.trim() || 'dashboards/org-marlow-media'; }

  function initNow(){
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(window.firebaseConfig);
        log('Initialized Firebase app', 'ok');
      } else {
        log('App already initialized', 'warn');
      }
      const db = firebase.firestore();
      try { db.settings({ experimentalAutoDetectLongPolling: true }); } catch(_){}
      window.__db = db;
      log('Got Firestore instance', 'ok');
    } catch(e) {
      log('Init failed: ' + (e && e.message), 'err');
    }
  }

  function ensureDb(){
    if (window.__db) return window.__db;
    if (!firebase.apps.length) {
      firebase.initializeApp(window.firebaseConfig);
      log('Initialized Firebase app (late)', 'ok');
    }
    const db = firebase.firestore();
    try { db.settings({ experimentalAutoDetectLongPolling: true }); } catch(_){}
    window.__db = db;
    return db;
  }

  async function readOrg(){
    try {
      const db = ensureDb();
      const docRef = db.doc(path());
      const snap = await docRef.get();
      if (!snap.exists) return log('Doc does not exist', 'warn');
      const data = snap.data() || {};
      log('Read OK. keys=' + Object.keys(data).join(','), 'ok');
      log(JSON.stringify({ tasks: (data.tasks||[]).slice(-3) }, null, 2));
    } catch(e) {
      log('Read failed: ' + (e && e.message), 'err');
    }
  }

  async function writeOrg(){
    try {
      const db = ensureDb();
      const docRef = db.doc(path());
      const snap = await docRef.get();
      const data = snap.exists ? (snap.data() || {}) : {};
      const tasks = Array.isArray(data.tasks) ? data.tasks.slice(0) : [];
      const task = {
        id: 'smoke-' + Date.now(),
        title: 'SMOKE',
        date: new Date().toISOString().split('T')[0],
        clientId: 'test',
        type: 'check',
        start: '09:00',
        duration: 60
      };
      tasks.push(task);
      await docRef.set({ tasks }, { merge: true });
      log('Write OK. tasks.length=' + tasks.length, 'ok');
    } catch(e) {
      log('Write failed: ' + (e && e.message), 'err');
    }
  }
</script>
</body>
</html>
